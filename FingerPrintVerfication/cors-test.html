<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS File Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background-color: #f5f5f5; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>CORS File Upload Test</h1>
    <p class="info">Change the API_BASE_URL below to your server's IP address (e.g., http://192.168.1.100:8080)</p>
    
    <div class="test-section">
        <h2>Configuration</h2>
        <label>API Base URL:</label>
        <input type="text" id="apiBaseUrl" value="http://localhost:8080" style="width: 300px;">
        <button onclick="updateApiUrl()">Update URL</button>
    </div>

    <div class="test-section">
        <h2>Test 1: Regular File Upload</h2>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="testFileUpload()">Test File Upload</button>
        <div id="fileResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Multiple File Upload</h2>
        <input type="file" id="multiFileInput" accept="image/*" multiple>
        <button onclick="testMultiFileUpload()">Test Multi File Upload</button>
        <div id="multiFileResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Base64 Upload</h2>
        <textarea id="base64Input" placeholder="Paste base64 image data here or click 'Use Sample' for a test image"></textarea>
        <br>
        <input type="text" id="fileNameInput" placeholder="Enter filename (e.g., test-image)" value="test-image">
        <br>
        <button onclick="useSampleBase64()">Use Sample Base64</button>
        <button onclick="testBase64Upload()">Test Base64 Upload</button>
        <div id="base64Result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: CORS Preflight Check</h2>
        <button onclick="testCorsOptions()">Test CORS OPTIONS</button>
        <div id="corsResult" class="result"></div>
    </div>

    <script>
        let API_BASE_URL = 'http://localhost:8080';

        function updateApiUrl() {
            API_BASE_URL = document.getElementById('apiBaseUrl').value;
            console.log('Updated API URL to:', API_BASE_URL);
        }

        function logResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML = `<span class="${isError ? 'error' : 'success'}">[${timestamp}] ${message}</span>`;
        }

        async function testFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                logResult('fileResult', 'Please select a file first', true);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('File', file);

                const response = await fetch(`${API_BASE_URL}/api/file`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.text();
                    logResult('fileResult', `✅ File upload successful! Response: ${result}`);
                } else {
                    logResult('fileResult', `❌ Upload failed: ${response.status} - ${response.statusText}`, true);
                }
            } catch (error) {
                logResult('fileResult', `❌ CORS or Network Error: ${error.message}`, true);
            }
        }

        async function testMultiFileUpload() {
            const fileInput = document.getElementById('multiFileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                logResult('multiFileResult', 'Please select at least one file', true);
                return;
            }

            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('Files', files[i]);
                }

                const response = await fetch(`${API_BASE_URL}/api/file/multi`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.text();
                    logResult('multiFileResult', `✅ Multi-file upload successful! Response: ${result}`);
                } else {
                    logResult('multiFileResult', `❌ Upload failed: ${response.status} - ${response.statusText}`, true);
                }
            } catch (error) {
                logResult('multiFileResult', `❌ CORS or Network Error: ${error.message}`, true);
            }
        }

        function useSampleBase64() {
            // Small 1x1 PNG image in base64
            const sampleBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAI9jU77zgAAAABJRU5ErkJggg==';
            document.getElementById('base64Input').value = sampleBase64;
        }

        async function testBase64Upload() {
            const base64Data = document.getElementById('base64Input').value.trim();
            const fileName = document.getElementById('fileNameInput').value.trim();
            
            if (!base64Data) {
                logResult('base64Result', 'Please enter base64 data', true);
                return;
            }
            
            if (!fileName) {
                logResult('base64Result', 'Please enter a filename', true);
                return;
            }

            try {
                const payload = {
                    base64Data: base64Data,
                    fileName: fileName,
                    imageFormat: 'png'
                };

                const response = await fetch(`${API_BASE_URL}/api/file/base64`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.text();
                    logResult('base64Result', `✅ Base64 upload successful! Response: ${result}`);
                } else {
                    logResult('base64Result', `❌ Upload failed: ${response.status} - ${response.statusText}`, true);
                }
            } catch (error) {
                logResult('base64Result', `❌ CORS or Network Error: ${error.message}`, true);
            }
        }

        async function testCorsOptions() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/file`, {
                    method: 'OPTIONS'
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().includes('access-control')) {
                        headers[key] = value;
                    }
                });

                logResult('corsResult', `✅ CORS OPTIONS successful! Headers: ${JSON.stringify(headers, null, 2)}`);
            } catch (error) {
                logResult('corsResult', `❌ CORS OPTIONS failed: ${error.message}`, true);
            }
        }

        // Test CORS on page load
        window.onload = function() {
            console.log('Page loaded. You can now test CORS functionality.');
            console.log('Current API URL:', API_BASE_URL);
        };
    </script>
</body>
</html>
